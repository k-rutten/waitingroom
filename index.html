<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Wachtkamer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', 'Inter', 'Segoe UI', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        :root {
            --system-blue: #007AFF;
            --system-green: #34C759;
            --system-red: #FF3B30;
            --system-teal: #5AC8FA;
            --system-orange: #FF9500;
            --system-gold: #FFD60A;
            --label-primary: rgba(0, 0, 0, 1);
            --label-secondary: rgba(60, 60, 67, 0.6);
            --label-tertiary: rgba(60, 60, 67, 0.3);
            --system-gray3: #C7C7CC;
            --system-gray5: #E5E5EA;
            --system-gray6: #F2F2F7;
            --card-bg: #FFFFFF;
        }
        body { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }

        /* Toast animations */
        @keyframes toast-in {
            from { opacity: 0; transform: translateY(8px) scale(0.96); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes toast-out {
            from { opacity: 1; transform: translateY(0) scale(1); }
            to { opacity: 0; transform: translateY(-4px) scale(0.98); }
        }
        .toast-enter { animation: toast-in 0.25s ease-out forwards; }
        .toast-exit { animation: toast-out 0.2s ease-in forwards; }

        /* Drop in animation */
        @keyframes drop-in {
            0% { opacity: 0; transform: translateY(-20px) scale(0.95); }
            60% { opacity: 1; transform: translateY(4px) scale(1.02); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }
        .drop-in { animation: drop-in 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }

        /* Pulse number animation */
        @keyframes pulse-number {
            0% { transform: scale(1); }
            50% { transform: scale(1.15); }
            100% { transform: scale(1); }
        }
        .pulse-number { animation: pulse-number 0.3s ease-in-out; }

        /* Soft glow for "your turn" */
        @keyframes soft-glow {
            0%, 100% { box-shadow: 0 0 0 0 rgba(52, 199, 89, 0); }
            50% { box-shadow: 0 0 0 8px rgba(52, 199, 89, 0.15); }
        }
        .soft-glow { animation: soft-glow 2s ease-in-out infinite; }

        /* Slide out right for doctor completing */
        @keyframes slide-out-right {
            to { opacity: 0; transform: translateX(60px); }
        }
        .slide-out-right { animation: slide-out-right 0.3s ease-in forwards; }

        /* Star pop in */
        @keyframes star-pop {
            0% { transform: scale(0); opacity: 0; }
            70% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Star fill */
        @keyframes star-fill {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }

        /* Confetti */
        @keyframes confetti-fall {
            0% { transform: translateY(0) rotate(0deg) scale(1); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg) scale(0.5); opacity: 0; }
        }

        /* Heartbeat pulse dot */
        @keyframes heartbeat {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
        .heartbeat { animation: heartbeat 2s ease-in-out infinite; }

        /* Fade in */
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fade-in 0.3s ease-out forwards; }

        /* Print styles */
        @media print {
            .no-print { display: none !important; }
            body { background: white !important; }
        }
    </style>
</head>
<body class="min-h-screen" style="background: var(--system-gray6);">
    <div id="root"></div>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef, useContext, createContext } = React;

        // ─── Data Layer ───────────────────────────────────────────────

        const STORAGE_KEY = 'waitingroom_queue';
        const PATIENT_ID_KEY = 'waitingroom_my_id';

        function createEmptyData() {
            return {
                queue: [],
                settings: { doctorPin: '1234', createdDate: new Date().toISOString().split('T')[0] }
            };
        }

        function loadData() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                return raw ? JSON.parse(raw) : createEmptyData();
            } catch { return createEmptyData(); }
        }

        function saveData(data) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        function generateId() {
            return 'wr_' + Date.now() + '_' + Math.random().toString(36).substring(2, 7);
        }

        function formatTime(timestamp) {
            const d = new Date(timestamp);
            return d.toLocaleTimeString('nl-NL', { hour: '2-digit', minute: '2-digit' });
        }

        // ─── Toast System ─────────────────────────────────────────────

        const ToastContext = createContext();

        function useToast() {
            return useContext(ToastContext);
        }

        function ToastProvider({ children }) {
            const [toasts, setToasts] = useState([]);

            const addToast = useCallback((message) => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, exiting: false }]);
                setTimeout(() => {
                    setToasts(prev => prev.map(t => t.id === id ? { ...t, exiting: true } : t));
                    setTimeout(() => {
                        setToasts(prev => prev.filter(t => t.id !== id));
                    }, 200);
                }, 2500);
            }, []);

            return (
                <ToastContext.Provider value={{ addToast }}>
                    {children}
                    <div style={{ position: 'fixed', top: '24px', left: '50%', transform: 'translateX(-50%)', zIndex: 9999, display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '8px', pointerEvents: 'none' }}>
                        {toasts.map(t => (
                            <div key={t.id} className={t.exiting ? 'toast-exit' : 'toast-enter'} style={{ background: 'rgba(0,0,0,0.8)', color: 'white', padding: '8px 20px', borderRadius: '999px', fontSize: '14px', fontWeight: 500, boxShadow: '0 4px 12px rgba(0,0,0,0.15)' }}>
                                {t.message}
                            </div>
                        ))}
                    </div>
                </ToastContext.Provider>
            );
        }

        // ─── Hash Router ──────────────────────────────────────────────

        function useHashRoute() {
            const [hash, setHash] = useState(window.location.hash || '#patient');
            useEffect(() => {
                const onHashChange = () => setHash(window.location.hash || '#patient');
                window.addEventListener('hashchange', onHashChange);
                return () => window.removeEventListener('hashchange', onHashChange);
            }, []);
            return hash;
        }

        // ─── Confetti Component ───────────────────────────────────────

        function Confetti() {
            const colors = ['#007AFF', '#34C759', '#FFD60A', '#5AC8FA', '#FF9500', '#FF3B30'];
            const particles = Array.from({ length: 30 }, (_, i) => ({
                id: i,
                left: Math.random() * 100,
                delay: Math.random() * 0.5,
                duration: 1.5 + Math.random() * 1,
                color: colors[i % colors.length],
                size: 6 + Math.random() * 6,
                rotation: Math.random() * 360,
                drift: (Math.random() - 0.5) * 200,
                isCircle: Math.random() > 0.5,
            }));

            return (
                <div style={{ position: 'fixed', top: 0, left: 0, width: '100%', height: '100%', pointerEvents: 'none', zIndex: 9998, overflow: 'hidden' }}>
                    {particles.map(p => (
                        <div key={p.id} style={{
                            position: 'absolute',
                            top: '-10px',
                            left: `${p.left}%`,
                            width: `${p.size}px`,
                            height: `${p.size}px`,
                            background: p.color,
                            borderRadius: p.isCircle ? '50%' : '2px',
                            transform: `rotate(${p.rotation}deg)`,
                            animation: `confetti-fall ${p.duration}s ease-in ${p.delay}s forwards`,
                        }} />
                    ))}
                </div>
            );
        }

        // ─── Star Rating Component ────────────────────────────────────

        function StarRating({ rating, setRating }) {
            return (
                <div style={{ display: 'flex', gap: '12px', justifyContent: 'center', padding: '16px 0' }}>
                    {[1, 2, 3, 4, 5].map(star => (
                        <button
                            key={star}
                            onClick={() => setRating(star)}
                            style={{
                                background: 'none', border: 'none', cursor: 'pointer', padding: '4px',
                                animation: `star-pop 0.3s ease-out ${star * 0.05}s both`,
                                transition: 'transform 0.15s ease',
                            }}
                            onMouseDown={e => e.currentTarget.style.transform = 'scale(0.9)'}
                            onMouseUp={e => e.currentTarget.style.transform = 'scale(1)'}
                        >
                            <svg width="44" height="44" viewBox="0 0 24 24" fill={star <= rating ? 'var(--system-gold)' : 'none'} stroke={star <= rating ? 'var(--system-gold)' : 'var(--system-gray3)'} strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"
                                style={{ transition: 'fill 0.15s ease, stroke 0.15s ease', ...(star <= rating && rating > 0 ? { animation: `star-fill 0.2s ease ${star * 0.03}s` } : {}) }}>
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                            </svg>
                        </button>
                    ))}
                </div>
            );
        }

        // ─── Patient View ─────────────────────────────────────────────

        function PatientJoinForm({ data, onJoin }) {
            const [lastName, setLastName] = useState('');
            const inputRef = useRef(null);
            const waitingCount = data.queue.filter(p => p.status !== 'done').length;

            const handleSubmit = (e) => {
                e.preventDefault();
                if (lastName.trim()) onJoin(lastName.trim());
            };

            return (
                <div className="fade-in" style={{ padding: '16px', maxWidth: '448px', margin: '0 auto' }}>
                    <div style={{ paddingTop: '48px', paddingBottom: '24px' }}>
                        <h1 style={{ fontSize: '34px', fontWeight: 700, color: 'var(--label-primary)', letterSpacing: '-0.37px', lineHeight: '41px' }}>Wachtkamer</h1>
                        <p style={{ fontSize: '15px', color: 'var(--label-secondary)', marginTop: '8px', lineHeight: '20px' }}>Voer uw achternaam in om u aan te melden</p>
                    </div>

                    <form onSubmit={handleSubmit}>
                        <div style={{ background: 'var(--card-bg)', borderRadius: '13px', padding: '20px', marginBottom: '16px' }}>
                            <label style={{ display: 'block', fontSize: '13px', fontWeight: 600, color: 'var(--label-secondary)', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '8px' }}>
                                Achternaam
                            </label>
                            <input
                                ref={inputRef}
                                type="text"
                                value={lastName}
                                onChange={e => setLastName(e.target.value)}
                                placeholder="Bijv. De Vries"
                                autoComplete="off"
                                autoCapitalize="words"
                                style={{
                                    width: '100%', height: '48px', padding: '0 16px',
                                    background: 'var(--system-gray6)', borderRadius: '6px',
                                    border: 'none', outline: 'none',
                                    fontSize: '17px', color: 'var(--label-primary)',
                                    fontFamily: 'inherit',
                                }}
                            />
                        </div>

                        <button
                            type="submit"
                            disabled={!lastName.trim()}
                            style={{
                                width: '100%', height: '50px', borderRadius: '13px',
                                background: lastName.trim() ? 'var(--system-blue)' : 'var(--system-gray3)',
                                color: 'white', border: 'none', cursor: lastName.trim() ? 'pointer' : 'default',
                                fontSize: '17px', fontWeight: 600,
                                transition: 'background 0.2s ease, transform 0.1s ease',
                                fontFamily: 'inherit',
                            }}
                            onMouseDown={e => { if (lastName.trim()) e.currentTarget.style.transform = 'scale(0.98)'; }}
                            onMouseUp={e => e.currentTarget.style.transform = 'scale(1)'}
                            onMouseLeave={e => e.currentTarget.style.transform = 'scale(1)'}
                        >
                            Aanmelden
                        </button>
                    </form>

                    {waitingCount > 0 && (
                        <p style={{ textAlign: 'center', fontSize: '13px', color: 'var(--label-secondary)', marginTop: '16px' }}>
                            Er wachten momenteel {waitingCount} {waitingCount === 1 ? 'persoon' : 'personen'}
                        </p>
                    )}
                </div>
            );
        }

        function PatientStatus({ data, patientId, onLeave }) {
            const [pulseKey, setPulseKey] = useState(0);
            const prevPositionRef = useRef(null);

            const patient = data.queue.find(p => p.id === patientId);
            if (!patient) return null;

            const activeQueue = data.queue.filter(p => p.status !== 'done');
            const myIndex = activeQueue.findIndex(p => p.id === patientId);
            const peopleAhead = myIndex >= 0 ? myIndex : 0;
            const isMyTurn = patient.status === 'in_progress';

            useEffect(() => {
                if (prevPositionRef.current !== null && prevPositionRef.current !== peopleAhead) {
                    setPulseKey(k => k + 1);
                }
                prevPositionRef.current = peopleAhead;
            }, [peopleAhead]);

            return (
                <div className="drop-in" style={{ padding: '16px', maxWidth: '448px', margin: '0 auto' }}>
                    <div style={{ paddingTop: '48px', paddingBottom: '24px' }}>
                        <h1 style={{ fontSize: '34px', fontWeight: 700, color: 'var(--label-primary)', letterSpacing: '-0.37px', lineHeight: '41px' }}>Wachtkamer</h1>
                        <p style={{ fontSize: '15px', color: 'var(--label-secondary)', marginTop: '8px', lineHeight: '20px' }}>
                            Aangemeld als <span style={{ fontWeight: 600, color: 'var(--label-primary)' }}>{patient.lastName}</span>
                        </p>
                    </div>

                    <div style={{
                        background: isMyTurn ? 'rgba(52, 199, 89, 0.06)' : 'var(--card-bg)',
                        borderRadius: '13px', padding: '32px 20px', textAlign: 'center',
                        marginBottom: '16px',
                    }} className={isMyTurn ? 'soft-glow' : ''}>
                        {isMyTurn ? (
                            <>
                                <div style={{ fontSize: '48px', marginBottom: '8px' }}>
                                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--system-green)" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" style={{ display: 'inline-block' }}>
                                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                        <polyline points="22 4 12 14.01 9 11.01"/>
                                    </svg>
                                </div>
                                <p style={{ fontSize: '22px', fontWeight: 700, color: 'var(--system-green)', marginBottom: '4px' }}>U bent aan de beurt!</p>
                                <p style={{ fontSize: '15px', color: 'var(--label-secondary)' }}>U kunt naar binnen</p>
                            </>
                        ) : (
                            <>
                                <div key={pulseKey} className={pulseKey > 0 ? 'pulse-number' : ''} style={{ fontSize: '64px', fontWeight: 700, color: 'var(--system-blue)', lineHeight: 1, marginBottom: '8px' }}>
                                    {peopleAhead}
                                </div>
                                <p style={{ fontSize: '17px', fontWeight: 600, color: 'var(--label-primary)', marginBottom: '4px' }}>
                                    {peopleAhead === 0 ? 'U bent de volgende' : peopleAhead === 1 ? '1 persoon voor u' : `${peopleAhead} personen voor u`}
                                </p>
                                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '6px', marginTop: '12px' }}>
                                    <div className="heartbeat" style={{ width: '6px', height: '6px', borderRadius: '50%', background: 'var(--system-blue)' }} />
                                    <p style={{ fontSize: '13px', color: 'var(--label-tertiary)' }}>Wordt automatisch bijgewerkt</p>
                                </div>
                            </>
                        )}
                    </div>

                    <button
                        onClick={onLeave}
                        style={{
                            width: '100%', height: '50px', borderRadius: '13px',
                            background: 'rgba(255, 59, 48, 0.1)',
                            color: 'var(--system-red)', border: 'none', cursor: 'pointer',
                            fontSize: '17px', fontWeight: 600,
                            transition: 'transform 0.1s ease',
                            fontFamily: 'inherit',
                        }}
                        onMouseDown={e => e.currentTarget.style.transform = 'scale(0.98)'}
                        onMouseUp={e => e.currentTarget.style.transform = 'scale(1)'}
                        onMouseLeave={e => e.currentTarget.style.transform = 'scale(1)'}
                    >
                        Afmelden
                    </button>
                </div>
            );
        }

        function PatientReview({ onSubmit, onSkip }) {
            const [rating, setRating] = useState(0);

            return (
                <div className="fade-in" style={{ padding: '16px', maxWidth: '448px', margin: '0 auto' }}>
                    <div style={{ paddingTop: '48px', paddingBottom: '24px', textAlign: 'center' }}>
                        <h1 style={{ fontSize: '34px', fontWeight: 700, color: 'var(--label-primary)', letterSpacing: '-0.37px', lineHeight: '41px' }}>Hoe was uw bezoek?</h1>
                        <p style={{ fontSize: '15px', color: 'var(--label-secondary)', marginTop: '8px', lineHeight: '20px' }}>Uw feedback helpt ons verbeteren</p>
                    </div>

                    <div style={{ background: 'var(--card-bg)', borderRadius: '13px', padding: '32px 20px', textAlign: 'center', marginBottom: '16px' }}>
                        <StarRating rating={rating} setRating={setRating} />

                        {rating > 0 && (
                            <button
                                onClick={() => onSubmit(rating)}
                                className="fade-in"
                                style={{
                                    width: '100%', height: '50px', borderRadius: '13px',
                                    background: 'var(--system-blue)', color: 'white',
                                    border: 'none', cursor: 'pointer',
                                    fontSize: '17px', fontWeight: 600, marginTop: '16px',
                                    transition: 'transform 0.1s ease',
                                    fontFamily: 'inherit',
                                }}
                                onMouseDown={e => e.currentTarget.style.transform = 'scale(0.98)'}
                                onMouseUp={e => e.currentTarget.style.transform = 'scale(1)'}
                            >
                                Verstuur
                            </button>
                        )}
                    </div>

                    <button
                        onClick={onSkip}
                        style={{
                            display: 'block', margin: '0 auto', background: 'none',
                            border: 'none', cursor: 'pointer', fontSize: '15px',
                            color: 'var(--label-secondary)', fontFamily: 'inherit',
                            padding: '12px 24px',
                        }}
                    >
                        Overslaan
                    </button>
                </div>
            );
        }

        function PatientThankYou({ showConfetti, onDone }) {
            useEffect(() => {
                const timer = setTimeout(onDone, showConfetti ? 4000 : 3000);
                return () => clearTimeout(timer);
            }, [onDone, showConfetti]);

            return (
                <div className="fade-in" style={{ padding: '16px', maxWidth: '448px', margin: '0 auto' }} onClick={onDone}>
                    {showConfetti && <Confetti />}
                    <div style={{ paddingTop: '80px', textAlign: 'center' }}>
                        <div style={{ marginBottom: '16px' }}>
                            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="var(--system-green)" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" style={{ display: 'inline-block' }}>
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                <polyline points="22 4 12 14.01 9 11.01"/>
                            </svg>
                        </div>
                        <h1 style={{ fontSize: '28px', fontWeight: 700, color: 'var(--label-primary)', marginBottom: '8px' }}>Bedankt voor uw bezoek!</h1>
                        <p style={{ fontSize: '15px', color: 'var(--label-secondary)', lineHeight: '20px' }}>
                            {showConfetti ? 'We waarderen uw feedback' : 'We hopen u goed geholpen te hebben'}
                        </p>
                    </div>
                </div>
            );
        }

        function PatientView({ data, setData }) {
            const [patientId, setPatientId] = useState(() => localStorage.getItem(PATIENT_ID_KEY) || null);
            const [phase, setPhase] = useState('join'); // join | waiting | review | thankyou
            const [showConfetti, setShowConfetti] = useState(false);
            const { addToast } = useToast();

            const patient = patientId ? data.queue.find(p => p.id === patientId) : null;

            // Determine phase based on patient state
            useEffect(() => {
                if (!patient || !patientId) {
                    if (phase !== 'review' && phase !== 'thankyou') {
                        setPhase('join');
                    }
                    return;
                }
                if (patient.status === 'done' && phase === 'waiting') {
                    setPhase('review');
                } else if (patient.status !== 'done' && phase === 'join') {
                    setPhase('waiting');
                }
            }, [patient, patientId, phase]);

            const handleJoin = (lastName) => {
                const newPatient = {
                    id: generateId(),
                    lastName,
                    joinedAt: Date.now(),
                    status: 'waiting',
                    completedAt: null,
                    rating: null,
                };
                setData(prev => ({ ...prev, queue: [...prev.queue, newPatient] }));
                setPatientId(newPatient.id);
                localStorage.setItem(PATIENT_ID_KEY, newPatient.id);
                setPhase('waiting');
                addToast('U bent aangemeld');
            };

            const handleLeave = () => {
                setData(prev => ({ ...prev, queue: prev.queue.filter(p => p.id !== patientId) }));
                setPatientId(null);
                localStorage.removeItem(PATIENT_ID_KEY);
                setPhase('join');
                addToast('U bent afgemeld');
            };

            const handleReviewSubmit = (rating) => {
                setData(prev => ({
                    ...prev,
                    queue: prev.queue.map(p => p.id === patientId ? { ...p, rating } : p)
                }));
                setShowConfetti(true);
                setPhase('thankyou');
            };

            const handleReviewSkip = () => {
                setShowConfetti(false);
                setPhase('thankyou');
            };

            const handleThankYouDone = useCallback(() => {
                setPatientId(null);
                localStorage.removeItem(PATIENT_ID_KEY);
                setPhase('join');
                setShowConfetti(false);
            }, []);

            if (phase === 'thankyou') return <PatientThankYou showConfetti={showConfetti} onDone={handleThankYouDone} />;
            if (phase === 'review') return <PatientReview onSubmit={handleReviewSubmit} onSkip={handleReviewSkip} />;
            if (phase === 'waiting' && patient) return <PatientStatus data={data} patientId={patientId} onLeave={handleLeave} />;
            return <PatientJoinForm data={data} onJoin={handleJoin} />;
        }

        // ─── Doctor View ──────────────────────────────────────────────

        function DoctorPinGate({ pin, onAuth }) {
            const [input, setInput] = useState('');
            const [shake, setShake] = useState(false);
            const { addToast } = useToast();

            const handleSubmit = (e) => {
                e.preventDefault();
                if (input === pin) {
                    onAuth();
                } else {
                    setShake(true);
                    addToast('Onjuiste pincode');
                    setTimeout(() => setShake(false), 500);
                    setInput('');
                }
            };

            return (
                <div className="fade-in" style={{ padding: '16px', maxWidth: '448px', margin: '0 auto' }}>
                    <div style={{ paddingTop: '80px', textAlign: 'center', paddingBottom: '32px' }}>
                        <div style={{ marginBottom: '16px' }}>
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--label-secondary)" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" style={{ display: 'inline-block' }}>
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                                <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                            </svg>
                        </div>
                        <h1 style={{ fontSize: '28px', fontWeight: 700, color: 'var(--label-primary)', letterSpacing: '-0.37px' }}>Artsentoegang</h1>
                        <p style={{ fontSize: '15px', color: 'var(--label-secondary)', marginTop: '8px' }}>Voer de pincode in om door te gaan</p>
                    </div>

                    <form onSubmit={handleSubmit}>
                        <div style={{
                            background: 'var(--card-bg)', borderRadius: '13px', padding: '20px', marginBottom: '16px',
                            transition: 'transform 0.1s ease',
                            transform: shake ? 'translateX(-8px)' : 'translateX(0)',
                            animation: shake ? 'none' : undefined,
                        }}>
                            <input
                                type="password"
                                inputMode="numeric"
                                pattern="[0-9]*"
                                maxLength={4}
                                value={input}
                                onChange={e => setInput(e.target.value.replace(/\D/g, ''))}
                                placeholder="• • • •"
                                autoComplete="off"
                                style={{
                                    width: '100%', height: '48px', padding: '0 16px',
                                    background: 'var(--system-gray6)', borderRadius: '6px',
                                    border: 'none', outline: 'none',
                                    fontSize: '24px', fontWeight: 600, color: 'var(--label-primary)',
                                    textAlign: 'center', letterSpacing: '8px',
                                    fontFamily: 'inherit',
                                }}
                            />
                        </div>

                        <button
                            type="submit"
                            disabled={input.length < 4}
                            style={{
                                width: '100%', height: '50px', borderRadius: '13px',
                                background: input.length >= 4 ? 'var(--system-blue)' : 'var(--system-gray3)',
                                color: 'white', border: 'none',
                                cursor: input.length >= 4 ? 'pointer' : 'default',
                                fontSize: '17px', fontWeight: 600,
                                transition: 'background 0.2s ease, transform 0.1s ease',
                                fontFamily: 'inherit',
                            }}
                            onMouseDown={e => { if (input.length >= 4) e.currentTarget.style.transform = 'scale(0.98)'; }}
                            onMouseUp={e => e.currentTarget.style.transform = 'scale(1)'}
                        >
                            Inloggen
                        </button>
                    </form>
                </div>
            );
        }

        function DoctorPatientCard({ patient, onAction, isFirst }) {
            const [sliding, setSliding] = useState(false);

            const statusColors = {
                waiting: 'var(--system-orange)',
                in_progress: 'var(--system-blue)',
                done: 'var(--system-green)',
            };

            const handleAction = () => {
                if (patient.status === 'in_progress') {
                    setSliding(true);
                    setTimeout(() => onAction(patient.id, 'done'), 300);
                } else {
                    onAction(patient.id, patient.status === 'waiting' ? 'in_progress' : 'done');
                }
            };

            return (
                <div
                    className={sliding ? 'slide-out-right' : ''}
                    style={{
                        background: 'var(--card-bg)', borderRadius: '13px', padding: '16px 20px',
                        display: 'flex', alignItems: 'center', gap: '12px',
                        marginBottom: '8px',
                    }}
                >
                    <div style={{ width: '10px', height: '10px', borderRadius: '50%', background: statusColors[patient.status], flexShrink: 0, transition: 'background 0.3s ease' }} />

                    <div style={{ flex: 1, minWidth: 0 }}>
                        <p style={{ fontSize: '17px', fontWeight: 600, color: 'var(--label-primary)', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>
                            {patient.lastName}
                        </p>
                        <p style={{ fontSize: '13px', color: 'var(--label-secondary)' }}>
                            {formatTime(patient.joinedAt)}
                            {patient.rating && <span> · {patient.rating} ★</span>}
                        </p>
                    </div>

                    {patient.status === 'waiting' && (
                        <button
                            onClick={handleAction}
                            style={{
                                height: '36px', padding: '0 16px', borderRadius: '9px',
                                background: isFirst ? 'var(--system-blue)' : 'rgba(0, 122, 255, 0.1)',
                                color: isFirst ? 'white' : 'var(--system-blue)',
                                border: 'none', cursor: 'pointer',
                                fontSize: '15px', fontWeight: 600, flexShrink: 0,
                                transition: 'transform 0.1s ease',
                                fontFamily: 'inherit',
                            }}
                            onMouseDown={e => e.currentTarget.style.transform = 'scale(0.95)'}
                            onMouseUp={e => e.currentTarget.style.transform = 'scale(1)'}
                        >
                            Volgende
                        </button>
                    )}
                    {patient.status === 'in_progress' && (
                        <button
                            onClick={handleAction}
                            style={{
                                height: '36px', padding: '0 16px', borderRadius: '9px',
                                background: 'var(--system-green)',
                                color: 'white', border: 'none', cursor: 'pointer',
                                fontSize: '15px', fontWeight: 600, flexShrink: 0,
                                transition: 'transform 0.1s ease',
                                fontFamily: 'inherit',
                            }}
                            onMouseDown={e => e.currentTarget.style.transform = 'scale(0.95)'}
                            onMouseUp={e => e.currentTarget.style.transform = 'scale(1)'}
                        >
                            Gereed
                        </button>
                    )}
                    {patient.status === 'done' && (
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--system-green)" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" style={{ flexShrink: 0 }}>
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                    )}
                </div>
            );
        }

        function DoctorView({ data, setData }) {
            const [showCompleted, setShowCompleted] = useState(false);
            const [showResetConfirm, setShowResetConfirm] = useState(false);
            const [showQR, setShowQR] = useState(false);
            const { addToast } = useToast();

            const activeQueue = data.queue.filter(p => p.status !== 'done');
            const completedQueue = data.queue.filter(p => p.status === 'done');
            const waitingCount = data.queue.filter(p => p.status === 'waiting').length;
            const inProgressCount = data.queue.filter(p => p.status === 'in_progress').length;

            const handleAction = (patientId, newStatus) => {
                setData(prev => ({
                    ...prev,
                    queue: prev.queue.map(p =>
                        p.id === patientId
                            ? { ...p, status: newStatus, completedAt: newStatus === 'done' ? Date.now() : p.completedAt }
                            : p
                    )
                }));
                if (newStatus === 'done') addToast('Patiënt afgerond');
                if (newStatus === 'in_progress') addToast('Patiënt opgeroepen');
            };

            const handleClearCompleted = () => {
                setData(prev => ({ ...prev, queue: prev.queue.filter(p => p.status !== 'done') }));
                addToast('Afgeronde patiënten gewist');
            };

            const handleResetQueue = () => {
                setData(prev => ({
                    ...prev,
                    queue: [],
                    settings: { ...prev.settings, createdDate: new Date().toISOString().split('T')[0] }
                }));
                setShowResetConfirm(false);
                addToast('Wachtrij gereset');
            };

            if (showQR) return <QRCodeView onBack={() => setShowQR(false)} />;

            return (
                <div className="fade-in no-print" style={{ padding: '16px', maxWidth: '448px', margin: '0 auto', paddingBottom: '100px' }}>
                    {/* Header */}
                    <div style={{ paddingTop: '48px', paddingBottom: '24px', display: 'flex', alignItems: 'flex-start', justifyContent: 'space-between' }}>
                        <div>
                            <h1 style={{ fontSize: '34px', fontWeight: 700, color: 'var(--label-primary)', letterSpacing: '-0.37px', lineHeight: '41px' }}>Wachtrij</h1>
                            <p style={{ fontSize: '15px', color: 'var(--label-secondary)', marginTop: '4px' }}>
                                {waitingCount} wachtend{inProgressCount > 0 ? ` · ${inProgressCount} aan de beurt` : ''} · {completedQueue.length} afgerond
                            </p>
                        </div>
                        <button
                            onClick={() => setShowQR(true)}
                            style={{
                                width: '44px', height: '44px', borderRadius: '13px',
                                background: 'rgba(0, 122, 255, 0.1)',
                                border: 'none', cursor: 'pointer',
                                display: 'flex', alignItems: 'center', justifyContent: 'center',
                                transition: 'transform 0.1s ease', marginTop: '4px',
                            }}
                            onMouseDown={e => e.currentTarget.style.transform = 'scale(0.9)'}
                            onMouseUp={e => e.currentTarget.style.transform = 'scale(1)'}
                        >
                            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--system-blue)" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                <rect x="3" y="3" width="7" height="7"/>
                                <rect x="14" y="3" width="7" height="7"/>
                                <rect x="3" y="14" width="7" height="7"/>
                                <rect x="14" y="14" width="7" height="7"/>
                            </svg>
                        </button>
                    </div>

                    {/* Active Queue */}
                    {activeQueue.length === 0 && completedQueue.length === 0 ? (
                        <div style={{ background: 'var(--card-bg)', borderRadius: '13px', padding: '48px 20px', textAlign: 'center' }}>
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--system-gray3)" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" style={{ display: 'inline-block', marginBottom: '12px' }}>
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                            </svg>
                            <p style={{ fontSize: '17px', fontWeight: 600, color: 'var(--label-secondary)' }}>Geen patiënten in de wachtrij</p>
                            <p style={{ fontSize: '13px', color: 'var(--label-tertiary)', marginTop: '4px' }}>Patiënten kunnen zich aanmelden via de QR code</p>
                        </div>
                    ) : (
                        <>
                            {activeQueue.length > 0 && (
                                <div style={{ marginBottom: '16px' }}>
                                    <p style={{ fontSize: '13px', fontWeight: 600, color: 'var(--label-secondary)', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '8px', paddingLeft: '4px' }}>
                                        Wachtend ({activeQueue.length})
                                    </p>
                                    {activeQueue.map((patient, index) => (
                                        <DoctorPatientCard
                                            key={patient.id}
                                            patient={patient}
                                            onAction={handleAction}
                                            isFirst={index === 0 && patient.status === 'waiting'}
                                        />
                                    ))}
                                </div>
                            )}

                            {/* Completed Section */}
                            {completedQueue.length > 0 && (
                                <div style={{ marginBottom: '16px' }}>
                                    <button
                                        onClick={() => setShowCompleted(!showCompleted)}
                                        style={{
                                            display: 'flex', alignItems: 'center', gap: '6px',
                                            background: 'none', border: 'none', cursor: 'pointer',
                                            fontSize: '13px', fontWeight: 600, color: 'var(--label-secondary)',
                                            textTransform: 'uppercase', letterSpacing: '0.5px',
                                            marginBottom: '8px', paddingLeft: '4px', fontFamily: 'inherit',
                                        }}
                                    >
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"
                                            style={{ transform: showCompleted ? 'rotate(90deg)' : 'rotate(0deg)', transition: 'transform 0.2s ease' }}>
                                            <polyline points="9 18 15 12 9 6"/>
                                        </svg>
                                        Afgerond ({completedQueue.length})
                                    </button>

                                    {showCompleted && (
                                        <div className="fade-in">
                                            {completedQueue.map(patient => (
                                                <DoctorPatientCard key={patient.id} patient={patient} onAction={handleAction} isFirst={false} />
                                            ))}
                                            <button
                                                onClick={handleClearCompleted}
                                                style={{
                                                    width: '100%', height: '44px', borderRadius: '13px',
                                                    background: 'rgba(255, 59, 48, 0.1)',
                                                    color: 'var(--system-red)', border: 'none', cursor: 'pointer',
                                                    fontSize: '15px', fontWeight: 600, marginTop: '8px',
                                                    fontFamily: 'inherit', transition: 'transform 0.1s ease',
                                                }}
                                                onMouseDown={e => e.currentTarget.style.transform = 'scale(0.98)'}
                                                onMouseUp={e => e.currentTarget.style.transform = 'scale(1)'}
                                            >
                                                Wis afgeronde patiënten
                                            </button>
                                        </div>
                                    )}
                                </div>
                            )}
                        </>
                    )}

                    {/* Reset Queue Button */}
                    {data.queue.length > 0 && (
                        <button
                            onClick={() => setShowResetConfirm(true)}
                            style={{
                                display: 'block', margin: '24px auto 0', background: 'none',
                                border: 'none', cursor: 'pointer', fontSize: '15px',
                                color: 'var(--system-red)', fontFamily: 'inherit',
                                padding: '12px 24px',
                            }}
                        >
                            Reset wachtrij
                        </button>
                    )}

                    {/* Reset Confirmation Dialog */}
                    {showResetConfirm && (
                        <div style={{
                            position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,
                            background: 'rgba(0,0,0,0.4)', display: 'flex',
                            alignItems: 'center', justifyContent: 'center', zIndex: 9990,
                            padding: '16px',
                        }} onClick={() => setShowResetConfirm(false)}>
                            <div className="drop-in" onClick={e => e.stopPropagation()} style={{
                                background: 'var(--card-bg)', borderRadius: '13px',
                                padding: '24px', maxWidth: '320px', width: '100%', textAlign: 'center',
                            }}>
                                <h3 style={{ fontSize: '17px', fontWeight: 600, color: 'var(--label-primary)', marginBottom: '8px' }}>Wachtrij resetten?</h3>
                                <p style={{ fontSize: '15px', color: 'var(--label-secondary)', marginBottom: '20px', lineHeight: '20px' }}>
                                    Alle patiënten worden verwijderd. Dit kan niet ongedaan worden gemaakt.
                                </p>
                                <div style={{ display: 'flex', gap: '8px' }}>
                                    <button
                                        onClick={() => setShowResetConfirm(false)}
                                        style={{
                                            flex: 1, height: '44px', borderRadius: '9px',
                                            background: 'var(--system-gray6)', color: 'var(--label-primary)',
                                            border: 'none', cursor: 'pointer', fontSize: '15px', fontWeight: 600,
                                            fontFamily: 'inherit',
                                        }}
                                    >
                                        Annuleren
                                    </button>
                                    <button
                                        onClick={handleResetQueue}
                                        style={{
                                            flex: 1, height: '44px', borderRadius: '9px',
                                            background: 'var(--system-red)', color: 'white',
                                            border: 'none', cursor: 'pointer', fontSize: '15px', fontWeight: 600,
                                            fontFamily: 'inherit',
                                        }}
                                    >
                                        Resetten
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // ─── QR Code View ─────────────────────────────────────────────

        function QRCodeView({ onBack }) {
            const qrRef = useRef(null);
            const patientUrl = window.location.origin + window.location.pathname + '#patient';

            useEffect(() => {
                if (qrRef.current) {
                    qrRef.current.innerHTML = '';
                    new QRCode(qrRef.current, {
                        text: patientUrl,
                        width: 256,
                        height: 256,
                        colorDark: '#000000',
                        colorLight: '#ffffff',
                        correctLevel: QRCode.CorrectLevel.H,
                    });
                }
            }, [patientUrl]);

            return (
                <div style={{ padding: '16px', maxWidth: '448px', margin: '0 auto', textAlign: 'center' }}>
                    <div className="no-print" style={{ paddingTop: '16px', paddingBottom: '24px', textAlign: 'left' }}>
                        <button
                            onClick={onBack}
                            style={{
                                display: 'flex', alignItems: 'center', gap: '4px',
                                background: 'none', border: 'none', cursor: 'pointer',
                                fontSize: '17px', color: 'var(--system-blue)', fontFamily: 'inherit',
                                padding: '8px 0',
                            }}
                        >
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
                                <polyline points="15 18 9 12 15 6"/>
                            </svg>
                            Terug
                        </button>
                    </div>

                    <div style={{ background: 'var(--card-bg)', borderRadius: '13px', padding: '40px 20px', marginBottom: '16px' }}>
                        <h2 style={{ fontSize: '28px', fontWeight: 700, color: 'var(--label-primary)', marginBottom: '8px' }}>Scan om aan te melden</h2>
                        <p style={{ fontSize: '15px', color: 'var(--label-secondary)', marginBottom: '32px' }}>Wachtkamer</p>

                        <div ref={qrRef} style={{ display: 'inline-block', marginBottom: '24px', borderRadius: '8px', overflow: 'hidden' }} />

                        <p style={{ fontSize: '13px', color: 'var(--label-tertiary)', wordBreak: 'break-all', padding: '0 16px' }}>
                            {patientUrl}
                        </p>
                    </div>

                    <button
                        onClick={() => window.print()}
                        className="no-print"
                        style={{
                            width: '100%', height: '50px', borderRadius: '13px',
                            background: 'var(--system-blue)', color: 'white',
                            border: 'none', cursor: 'pointer',
                            fontSize: '17px', fontWeight: 600,
                            transition: 'transform 0.1s ease',
                            fontFamily: 'inherit',
                        }}
                        onMouseDown={e => e.currentTarget.style.transform = 'scale(0.98)'}
                        onMouseUp={e => e.currentTarget.style.transform = 'scale(1)'}
                    >
                        Afdrukken
                    </button>
                </div>
            );
        }

        // ─── Tab Bar ───────────────────────────────────────────────────

        function TabBar({ route }) {
            const isPatient = route !== '#doctor';
            const isDoctor = route === '#doctor';

            return (
                <div className="no-print" style={{
                    position: 'fixed', bottom: 0, left: 0, right: 0,
                    background: 'rgba(255, 255, 255, 0.92)', backdropFilter: 'blur(20px)', WebkitBackdropFilter: 'blur(20px)',
                    borderTop: '1px solid var(--system-gray5)',
                    paddingBottom: 'env(safe-area-inset-bottom, 0px)',
                    zIndex: 9000,
                }}>
                    <div style={{ display: 'flex', maxWidth: '448px', margin: '0 auto' }}>
                        <a
                            href="#patient"
                            style={{
                                flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center',
                                padding: '8px 0 6px', textDecoration: 'none',
                                color: isPatient ? 'var(--system-blue)' : 'var(--label-tertiary)',
                                transition: 'color 0.2s ease',
                            }}
                        >
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                <circle cx="12" cy="7" r="4"/>
                            </svg>
                            <span style={{ fontSize: '10px', fontWeight: 500, marginTop: '2px' }}>Patiënt</span>
                        </a>
                        <a
                            href="#doctor"
                            style={{
                                flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center',
                                padding: '8px 0 6px', textDecoration: 'none',
                                color: isDoctor ? 'var(--system-blue)' : 'var(--label-tertiary)',
                                transition: 'color 0.2s ease',
                            }}
                        >
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round">
                                <rect x="3" y="3" width="18" height="18" rx="2"/>
                                <path d="M9 3v18"/>
                                <path d="M13 8h4"/>
                                <path d="M13 12h4"/>
                                <path d="M13 16h4"/>
                            </svg>
                            <span style={{ fontSize: '10px', fontWeight: 500, marginTop: '2px' }}>Arts</span>
                        </a>
                    </div>
                </div>
            );
        }

        // ─── App Router ───────────────────────────────────────────────

        function App({ data, setData, route }) {
            const [doctorAuthenticated, setDoctorAuthenticated] = useState(false);

            return (
                <>
                    {route === '#doctor' ? (
                        !doctorAuthenticated
                            ? <DoctorPinGate pin={data.settings.doctorPin} onAuth={() => setDoctorAuthenticated(true)} />
                            : <DoctorView data={data} setData={setData} />
                    ) : (
                        <PatientView data={data} setData={setData} />
                    )}
                    <TabBar route={route} />
                </>
            );
        }

        // ─── Root ─────────────────────────────────────────────────────

        function Root() {
            const [data, setData] = useState(() => {
                const loaded = loadData();
                // Auto-reset if new day
                const today = new Date().toISOString().split('T')[0];
                if (loaded.settings.createdDate !== today) {
                    const fresh = { queue: [], settings: { ...loaded.settings, createdDate: today } };
                    saveData(fresh);
                    return fresh;
                }
                return loaded;
            });
            const route = useHashRoute();

            // Persist to localStorage on change
            useEffect(() => { saveData(data); }, [data]);

            // Cross-tab sync via storage event
            useEffect(() => {
                const onStorage = (e) => {
                    if (e.key === STORAGE_KEY && e.newValue) {
                        try { setData(JSON.parse(e.newValue)); } catch {}
                    }
                };
                window.addEventListener('storage', onStorage);
                return () => window.removeEventListener('storage', onStorage);
            }, []);

            // Polling fallback every 2s
            useEffect(() => {
                const interval = setInterval(() => {
                    const fresh = loadData();
                    setData(prev => JSON.stringify(prev) !== JSON.stringify(fresh) ? fresh : prev);
                }, 2000);
                return () => clearInterval(interval);
            }, []);

            return (
                <ToastProvider>
                    <App data={data} setData={setData} route={route} />
                </ToastProvider>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<Root />);
    </script>
</body>
</html>
